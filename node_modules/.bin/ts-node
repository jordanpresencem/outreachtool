#!/usr/bin/env node
const { spawnSync } = require('child_process');
const path = require('path');

function usage() {
  console.error('Usage: ts-node <file> [args...]');
  process.exit(1);
}

const [, , entry, ...args] = process.argv;
if (!entry) usage();

const tscResult = spawnSync('tsc', { stdio: 'inherit' });
if (tscResult.status !== 0) {
  process.exit(tscResult.status ?? 1);
}

const relativeEntry = entry.replace(/^\.\/+/, '');
const distPath = path.join(
  'dist',
  relativeEntry.startsWith('src/') ? relativeEntry.slice(4) : relativeEntry,
);
const jsPath = distPath.replace(/\.ts$/, '.js');
const resolvedJsPath = path.resolve(process.cwd(), jsPath);

const nodeResult = spawnSync('node', [resolvedJsPath, ...args], { stdio: 'inherit' });
process.exit(nodeResult.status ?? 0);
